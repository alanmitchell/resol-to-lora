# Notes on Auto-mounting USB Flash Drives

Ultimately, the solution below was used, generated by ChatGPT.  The two files
mentioned below are in the root directory of this repo, configured
properly for use with this application.

---

Yes, you can use systemd's `.automount` units to automatically mount USB flash drives when they are plugged in and accessed. However, setting this up can be a bit complex because systemd does not directly provide a way to create `.automount` units for arbitrary devices like USB flash drives. You'll need to create udev rules to generate the necessary systemd units.

Here's a basic example of how you can set this up:

1. **Create a udev rule:** Create a file at `/etc/udev/rules.d/99-usb-automount.rules` with the following content:

    ```bash
    ACTION=="add", SUBSYSTEM=="block", ENV{DEVTYPE}=="partition", TAG+="systemd", ENV{SYSTEMD_WANTS}="usb-automount@%k.service"
    ```

    This rule will be triggered when a partition is added (i.e., when a USB flash drive is plugged in). It adds a systemd tag to the device and sets a systemd service to be started.

2. **Create a systemd service template:** Create a file at `/etc/systemd/system/usb-automount@.service` with the following content:

    ```bash
    [Unit]
    Description=Automount USB flash drive

    [Service]
    Type=oneshot
    ExecStart=/bin/systemd-mount /dev/%I /mnt/usb-%I
    ```

    This is a service template that will be instantiated for each USB flash drive. It runs `systemd-mount` to mount the drive at a directory under `/mnt`.

3. **Reload udev and systemd:** After creating the udev rule and the systemd service template, you need to reload the udev rules and the systemd configuration:

    ```bash
    sudo udevadm control --reload-rules
    sudo systemctl daemon-reload
    ```

With this setup, when you plug in a USB flash drive, udev will trigger the `usb-automount@.service` systemd service, which will mount the drive at `/mnt/usb-sdx1` (replace `sdx1` with the actual device node of the flash drive).

Please note that this is a very basic example and might not cover all use cases. You might need to adjust the udev rule and the systemd service template to fit your specific needs. Also, remember that you need to create the mount point directories before you can mount anything there.

---

The answer below was used to trigger my status script after the
USB Flash drive is inserted:

---
To trigger another script after the USB drive has been mounted, you can modify the systemd service template to execute the script. Here's how you can do it:

1. **Modify the systemd service template:** Open the file `/etc/systemd/system/usb-automount@.service` and modify it to look like this:

    ```bash
    [Unit]
    Description=Automount USB flash drive

    [Service]
    Type=oneshot
    ExecStart=/bin/systemd-mount /dev/%I /mnt/usb-%I
    ExecStartPost=/path/to/your/script.sh
    ```

    In this file, replace `/path/to/your/script.sh` with the actual path to your script. The `ExecStartPost` directive specifies a command to be run after the `ExecStart` command has successfully completed. In this case, it will run your script after the drive has been mounted.

2. **Reload systemd:** After modifying the systemd service template, you need to reload the systemd configuration:

    ```bash
    sudo systemctl daemon-reload
    ```

With this setup, when you plug in a USB flash drive, udev will trigger the `usb-automount@.service` systemd service, which will mount the drive and then run your script.

Please note that your script will be run as the root user, because systemd services are run as root by default. If you need to run the script as a different user, you can use the `su` or `sudo` command in the `ExecStartPost` directive to change the user. For example:

```bash
ExecStartPost=/bin/su -c '/path/to/your/script.sh' username
```

Or:

```bash
ExecStartPost=/usr/bin/sudo -u username /path/to/your/script.sh
```

In these examples, replace `username` with the name of the user you want to run the script as.